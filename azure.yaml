# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: zava-cora-agent
metadata:
  template: zava-cora-agent@1.0.0

# Use custom infrastructure in ./infra folder
infra:
  provider: bicep
  path: infra
  module: main

services:
  # Cora Web Application - the main AI agent chat interface
  web-app:
    project: .
    language: python
    host: containerapp
    docker:
      path: Dockerfile
      context: .

# Azure Developer CLI hooks
hooks:
  # Pre-provision: ensure user is logged in
  preprovision:
    shell: pwsh
    run: |
      Write-Host "Checking Azure login status..."
      $account = az account show 2>$null | ConvertFrom-Json
      if (-not $account) {
        Write-Host "Not logged in. Please run 'az login' first."
        exit 1
      }
      Write-Host "Logged in as: $($account.user.name)"

  # Post-provision: Initialize database and display connection info
  postprovision:
    shell: pwsh
    run: |
      Write-Host ""
      Write-Host "=== Initializing Database ===" -ForegroundColor Cyan
      
      # Get backup file path - use current working directory
      $ProjectPath = Get-Location
      $BackupFile = Join-Path $ProjectPath "data\zava_retail_2025_07_21_postgres_rls.backup"
      $PostgresHost = "$env:POSTGRES_SERVER_NAME.postgres.database.azure.com"
      
      Write-Host "PostgreSQL Server: $PostgresHost"
      Write-Host "Database: $env:POSTGRES_DATABASE_NAME"
      Write-Host "Backup File: $BackupFile"
      
      if (Test-Path $BackupFile) {
        Write-Host "Restoring database backup using Docker..." -ForegroundColor Yellow
        
        # Convert Windows path to Docker-compatible path
        $DockerBackupPath = $BackupFile -replace '\\', '/'
        
        docker run --rm `
          -v "${BackupFile}:/backup.dump:ro" `
          -e "PGPASSWORD=$env:POSTGRES_ADMIN_PASSWORD" `
          postgres:17 `
          pg_restore `
          --host=$PostgresHost `
          --port=5432 `
          --username=zadmin `
          --dbname=$env:POSTGRES_DATABASE_NAME `
          --verbose `
          --no-owner `
          --no-privileges `
          --if-exists `
          --clean `
          /backup.dump
        
        if ($LASTEXITCODE -eq 0 -or $LASTEXITCODE -eq 1) {
          Write-Host "Database restore completed!" -ForegroundColor Green
          $LASTEXITCODE = 0  # Reset to success - pg_restore exits 1 for warnings
        } else {
          Write-Host "Warning: Database restore had issues (exit code: $LASTEXITCODE)" -ForegroundColor Yellow
        }
      } else {
        Write-Host "Warning: Backup file not found at $BackupFile" -ForegroundColor Yellow
      }
      
      # Ensure script exits with success
      exit 0
      
      Write-Host ""
      Write-Host "=== Deployment Complete ===" -ForegroundColor Green
      Write-Host "Web App URL: $env:SERVICE_WEB_APP_URI"
      Write-Host "AI Project: $env:AZURE_AI_PROJECT_NAME"
      Write-Host ""
      Write-Host "To view logs: az containerapp logs show -n $env:SERVICE_WEB_APP_NAME -g $env:AZURE_RESOURCE_GROUP"
